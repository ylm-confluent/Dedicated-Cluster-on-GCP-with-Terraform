# Private Link Attachment Connection Setup

## Overview

This document explains the Private Link Attachment Connection setup for accessing the Confluent Cloud Kafka cluster via GCP Private Service Connect.

## What Was Added

### 1. **Google Provider Upgrade**
- Upgraded from version `4.18.0` to `~> 5.0` (currently `5.45.2`)
- Required to access the `psc_connection_id` attribute on forwarding rules

### 2. **Data Source for PSC Connection IDs**
```hcl
data "google_compute_forwarding_rule" "psc_endpoints"
```
- Retrieves the PSC connection IDs from the already-created GCP forwarding rules
- These IDs are automatically generated by GCP when Private Service Connect endpoints are created
- One data source per availability zone (europe-west1-b, europe-west1-c, europe-west1-d)

### 3. **Private Link Attachment Connection Resources**
```hcl
resource "confluent_private_link_attachment_connection" "gcp"
```
- Creates the connection between GCP Private Service Connect and Confluent Cloud
- One connection per availability zone for high availability
- Uses the PSC connection IDs from the forwarding rules
- Connects to the Private Link Attachment (`platt-8xxzwj`)

### 4. **Updated Dependencies**
Updated the following resources to depend on the Private Link Attachment Connections:
- `confluent_api_key.app-manager-kafka-api-key`
- `confluent_api_key.app-consumer-kafka-api-key`
- `confluent_api_key.app-producer-kafka-api-key`

This ensures API keys are only created after network connectivity is fully established.

### 5. **New Outputs**
Added two new outputs:
- `private_link_attachment_connection` - Details of all connection resources
- `private_link_setup_complete` - Confirmation message with setup status

## Why This Is Needed

When you create a Kafka cluster with Private Link Attachment in Confluent Cloud, you need to:

1. **Create the Private Link Attachment** (`confluent_private_link_attachment`)
   - Confluent provides a service attachment for GCP
   - This is the "gateway" that Confluent sets up

2. **Create GCP Private Service Connect Endpoints** (`google_compute_forwarding_rule`)
   - Your VPC creates forwarding rules that connect to Confluent's service attachment
   - GCP automatically generates PSC connection IDs for each endpoint

3. **Register the Connections with Confluent** (`confluent_private_link_attachment_connection`)
   - **THIS IS THE MISSING PIECE!**
   - You must tell Confluent about the PSC connections from your VPC
   - Without this, Confluent Cloud shows: "You require additional setup to access this kafka cluster"

## What Gets Created

When you run `terraform apply`, Terraform will create:

1. **3 Private Link Attachment Connections** (one per zone):
   - `takealot-poc-europe-west1-b-connection` (PSC ID: 52082010549649411)
   - `takealot-poc-europe-west1-c-connection` (PSC ID: 52082010549649412)
   - `takealot-poc-europe-west1-d-connection` (PSC ID: 52082010549649410)

2. **6 Bastion VM Resources** (if `create_bastion_vm=true`):
   - Service account for the VM
   - IAM role bindings
   - External IP address
   - SSH firewall rule
   - The VM instance itself

## How to Apply

### Option 1: Apply Everything (Recommended)
```bash
source env.sh
terraform apply
```

This will create:
- The 3 Private Link Attachment Connections
- The bastion VM (if `TF_VAR_create_bastion_vm=true`)

### Option 2: Apply Only Private Link Connections
If you don't want the bastion VM yet:
```bash
source env.sh
export TF_VAR_create_bastion_vm=false
terraform apply
```

## Verification

After applying, you can verify the setup:

### 1. Check Terraform Outputs
```bash
terraform output private_link_setup_complete
```

### 2. Check Confluent Cloud UI
1. Go to Confluent Cloud Console
2. Navigate to your environment: `Take-alot-POC` (env-1dg275)
3. Click on your cluster: `takealot-poc` (lkc-drmo3y)
4. Go to "Networking" section
5. The warning "You require additional setup to access this kafka cluster" should be **GONE**
6. You should see 3 active connections listed

### 3. Test Connectivity from Bastion VM
Once the bastion VM is created:
```bash
# SSH into the VM
ssh terraform@<BASTION_IP>

# Test DNS resolution
nslookup lkc-drmo3y.europe-west1.gcp.private.confluent.cloud

# Test Kafka REST API connectivity
curl -u '<API_KEY>:<API_SECRET>' \
  https://lkc-drmo3y.europe-west1.gcp.private.confluent.cloud:443/kafka/v3/clusters
```

## PSC Connection IDs

The PSC connection IDs are unique numeric identifiers generated by GCP:
- **europe-west1-b**: 52082010549649411
- **europe-west1-c**: 52082010549649412
- **europe-west1-d**: 52082010549649410

These are automatically discovered from the forwarding rules and registered with Confluent.

## Troubleshooting

### "Unsupported attribute: psc_connection_id"
- Make sure you've upgraded the Google provider to version 5.x
- Run `terraform init -upgrade` to get the latest provider version

### "You require additional setup to access this kafka cluster"
- Ensure the Private Link Attachment Connection resources are created
- Run `terraform output private_link_attachment_connection` to check
- Check Confluent Cloud UI to see if connections are showing as "Pending" or "Active"

### Cannot access Kafka from local machine
- This is expected! The cluster is only accessible from within the VPC
- You need to use the bastion VM or deploy your application in the VPC
- Set `create_bastion_vm=true` and deploy the bastion VM for testing

## Next Steps

After the Private Link Attachment Connections are active:

1. **Create the Bastion VM** (if not already done):
   ```bash
   ./setup-ssh.sh
   source env.sh
   export TF_VAR_create_bastion_vm=true
   terraform apply
   ```

2. **SSH into the Bastion VM**:
   ```bash
   ssh -i ~/.ssh/confluent_bastion terraform@<BASTION_IP>
   ```

3. **Deploy Private Resources** (topics, ACLs):
   ```bash
   # On the bastion VM:
   cd ~/confluent-terraform
   # Edit env.sh and set: export TF_VAR_create_private_resources=true
   vim env.sh
   source env.sh
   terraform apply
   ```

4. **Test Kafka Connectivity**:
   ```bash
   # Produce test messages
   echo '{"order_id": 1, "customer": "test"}' | \
     confluent kafka topic produce orders \
     --cluster lkc-drmo3y \
     --api-key <API_KEY> \
     --api-secret <API_SECRET>
   
   # Consume test messages
   confluent kafka topic consume orders \
     --from-beginning \
     --cluster lkc-drmo3y \
     --api-key <API_KEY> \
     --api-secret <API_SECRET>
   ```

## Cost Implications

### Private Link Attachment Connection
- **No additional cost** from Confluent
- These connections enable network access but don't incur charges

### GCP Private Service Connect
- **~$0.01 per hour per forwarding rule** = ~$0.03/hour for 3 zones
- **~$22/month** for the Private Service Connect endpoints

### Bastion VM
- **e2-medium instance**: ~$25/month (if running 24/7)
- **External IP**: ~$3/month
- **Consider stopping the VM when not in use** to save costs

### Total Additional Cost
- **Private Link Connections**: ~$22/month (PSC endpoints)
- **Bastion VM** (optional): ~$28/month if always running

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│  GCP Project: solutionsarchitect-01                         │
│  Region: europe-west1                                       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  VPC: confluent-vpc (10.0.0.0/16)                   │   │
│  │                                                      │   │
│  │  ┌────────────────────────────────────────────────┐ │   │
│  │  │  Subnet: confluent-subnet (10.0.0.0/24)       │ │   │
│  │  │                                                 │ │   │
│  │  │  ┌──────────────────┐                         │ │   │
│  │  │  │  Bastion VM      │                         │ │   │
│  │  │  │  (Optional)      │                         │ │   │
│  │  │  └────────┬─────────┘                         │ │   │
│  │  │           │                                    │ │   │
│  │  └───────────┼────────────────────────────────────┘ │   │
│  │              │                                      │   │
│  │  ┌───────────┼────────────────────────────────────┐ │   │
│  │  │ PSC Subnets (10.0.1-3.0/24)                    │ │   │
│  │  │           │                                    │ │   │
│  │  │  ┌────────▼─────────┐  ┌──────────────┐      │ │   │
│  │  │  │ Forwarding Rule  │  │ DNS Zone     │      │ │   │
│  │  │  │ europe-west1-b   │  │ *.europe-    │      │ │   │
│  │  │  │ (PSC: ...411)    │  │  west1.gcp   │      │ │   │
│  │  │  └────────┬─────────┘  │ .private     │      │ │   │
│  │  │           │            │ .confluent   │      │ │   │
│  │  │  ┌────────▼─────────┐  │ .cloud       │      │ │   │
│  │  │  │ Forwarding Rule  │  └──────────────┘      │ │   │
│  │  │  │ europe-west1-c   │                        │ │   │
│  │  │  │ (PSC: ...412)    │                        │ │   │
│  │  │  └────────┬─────────┘                        │ │   │
│  │  │           │                                   │ │   │
│  │  │  ┌────────▼─────────┐                        │ │   │
│  │  │  │ Forwarding Rule  │                        │ │   │
│  │  │  │ europe-west1-d   │                        │ │   │
│  │  │  │ (PSC: ...410)    │                        │ │   │
│  │  │  └────────┬─────────┘                        │ │   │
│  │  └───────────┼──────────────────────────────────┘ │   │
│  └──────────────┼────────────────────────────────────┘   │
└─────────────────┼──────────────────────────────────────┐
                  │                                        
        ┌─────────▼────────────────────────┐               
        │  Confluent Cloud                │               
        │  Private Service Connect         │               
        │  Service Attachment              │               
        │                                  │               
        │  ┌───────────────────────────┐  │               
        │  │ Private Link Attachment   │  │               
        │  │ takealot-poc-gcp-platt    │  │               
        │  │ (platt-8xxzwj)            │  │               
        │  │                           │  │               
        │  │ ┌───────────────────────┐ │  │               
        │  │ │ Connection: ...411    │ │  │  ◄────┐       
        │  │ │ (europe-west1-b)      │ │  │       │       
        │  │ └───────────────────────┘ │  │       │       
        │  │ ┌───────────────────────┐ │  │       │ These
        │  │ │ Connection: ...412    │ │  │       │ are  
        │  │ │ (europe-west1-c)      │ │  │       │ what 
        │  │ └───────────────────────┘ │  │       │ we're
        │  │ ┌───────────────────────┐ │  │       │ adding!
        │  │ │ Connection: ...410    │ │  │       │       
        │  │ │ (europe-west1-d)      │ │  │       │       
        │  │ └───────────────────────┘ │  │  ◄────┘       
        │  └───────────────────────────┘  │               
        │                                  │               
        │  ┌───────────────────────────┐  │               
        │  │ Kafka Cluster             │  │               
        │  │ takealot-poc              │  │               
        │  │ (lkc-drmo3y)              │  │               
        │  │ Enterprise / High Avail.  │  │               
        │  └───────────────────────────┘  │               
        └──────────────────────────────────┘               
```

## References

- [Confluent Private Link Attachment Documentation](https://docs.confluent.io/cloud/current/networking/private-links/gcp-privatelink.html)
- [GCP Private Service Connect Documentation](https://cloud.google.com/vpc/docs/private-service-connect)
- [Confluent Terraform Provider - Private Link Attachment Connection](https://registry.terraform.io/providers/confluentinc/confluent/latest/docs/resources/confluent_private_link_attachment_connection)
